# Планировщик коллбеков

## Позволяет: 
- добавлять коллбеки и вызывать их в указанное при добавлении время;
- отменять добавленные ранее, но еще не выполненные коллбеки;

## 2 версии отмены-
- "ленивая" отмена - коллбек помечается как отмененный, при этом остается внутри планировщика до момента срабатывания(выполнен не будет, т.к помечен как удаленный)
- явное удаление - коллбек удаляется из планировщика явно при запросе на удаление;

# Особенности реализации-
## Ленивая отмена-
См. реализацию: [include/lazy_canellation/callback_scheduler.hpp](include/lazy_canellation/callback_scheduler.hpp)

1. Коллбеки исполняются в отдельном потоке, который запускается при создании планировщика
2. Коллбек представляет из себя объект структуры, которая хранит callable- объект(`std::function`), целочисленный идентификатор и время срабатывания коллбека.
3. Коллбеки хранятся в приоритетной очереди(`std::priority_queue`), приоритет определяется по времени срабатывания коллбека (чем раньше, тем выше приоритет). Для определения приоритета структура коллбека реализует `operator<`
4. Для обеспечения работы планировщика используется пара `std::condition_variable` и `std::mutex`

### Добавление коллбека-
При добавлении коллбеку назначается идентификатор (инкрементируемый счетчик внутри планировщика)
Если очередь коллбеков пуста или время срабатывания добавляемого коллбека меньше времени срабатывания самого раннего коллбека в очереди, то нотифицируется условная переменная на которой ожидает рабочий поток планировщика. Идентификатор добавленного коллбека возвращается пользователю для возможности отмены коллбека.

Рабочий поток планировщика ожидает наступления времени срабатывания самого раннего коллбека на условной переменной, при этом может быть разбужен добавлением коллбека с более ранним временем срабатывания

При пробуждении проверяется что идентификатор потока не находится в списке отмененных. Коллбек выполняется только если он не был отменен.

### Удаление коллбека(отмена)
При удалении, идентификатор удаляемого коллбека помещается в список (`std::unordered_set`) коллбеков помеченных как отмененные.


## Явное удаление-
См. реализацию: [include/eager_cancellation/callback_scheduler.hpp](include/eager_cancellation/callback_scheduler.hpp)

1. Очередь с приоритетом заменяется на пару контрейнеров- `std::multimap`(нужен именно multi, чтобы была возможность добавить коллбеки с одинаковым временем срабатывания), где ключем является время срабатывания коллбека а значением- объект коллбека и, вспомогательный `std::unordered_map` где ключем является идентификатор коллбека, а значением- итератор на объект коллбека в `std::multimap`
Второй контейнер нужен для возможности удаления еще не сработавшего коллбека по запросу от пользователя.
2. Коллбек- объект структуры, которая хранит callable- объект и целочисленный идентификатор коллбека

### Добавление коллбека
Добавление аналогично варианту с ленивой отменой, но пара "время срабатывания - коллбек", добавляется в `std::multimap`, а пара "идентификатор-итератор" добавляeтся в `std::unordered_map`

Рабочий поток планировщика также ожидает на условной переменной, но теперь коллбеки которые были удалены отсутствуют в `std::multimap` и не будут выполнены. Также после извлечения коллбека из контейнера, информация о коллбеке должна быть удалена из служебного `std::unordered_map`

### Удаление коллбека
При удалении коллбека, в `std::unordered_map` по переданному идентификатору ищется итератор на коллбек, при помощи которого коллбек сразу же удаляется из `std::multimap`
